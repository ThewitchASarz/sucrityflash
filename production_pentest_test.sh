#!/bin/bash
# SecurityFlash Production Test - Real Pentest Workflow
# Target: example.com (safe test target)

set -e

BFF_URL="http://localhost:3001/api/v1"
V1_URL="http://localhost:8000/api/v1"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ›¡ï¸  SecurityFlash Production Pentest Test"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Target: example.com"
echo "V2 BFF: $BFF_URL"
echo "V1 API:  $V1_URL"
echo ""

# Step 1: Create Project
echo "ğŸ“ [1/5] Creating pentest project..."
PROJECT=$(curl -s -X POST "$BFF_URL/projects" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Example.com Security Assessment",
    "customer_id": "test-customer-001",
    "created_by": "security-team",
    "rules_of_engagement": "Non-intrusive reconnaissance only. Target: example.com"
  }')

PROJECT_ID=$(echo "$PROJECT" | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null)

if [ -z "$PROJECT_ID" ]; then
  echo "âŒ Failed to create project"
  echo "$PROJECT" | python3 -m json.tool 2>/dev/null || echo "$PROJECT"
  exit 1
fi

echo "âœ… Project Created"
echo "   ID: $PROJECT_ID"
echo "$PROJECT" | python3 -m json.tool 2>/dev/null | head -15

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 2: Create Scope
echo "ğŸ¯ [2/5] Defining pentest scope..."
SCOPE=$(curl -s -X POST "$BFF_URL/projects/$PROJECT_ID/scopes" \
  -H "Content-Type: application/json" \
  -d '{
    "scope_type": "web_app",
    "targets": [
      {
        "type": "domain",
        "value": "example.com",
        "description": "Primary target domain"
      },
      {
        "type": "ip",
        "value": "93.184.216.34",
        "description": "example.com IP address"
      }
    ],
    "excluded_targets": [],
    "attack_vectors_allowed": ["reconnaissance", "information_gathering", "port_scanning"],
    "attack_vectors_prohibited": ["sql_injection", "xss", "command_injection", "dos"],
    "approved_tools": ["nmap", "curl", "dig", "whois", "nslookup"],
    "time_restrictions": {
      "start_time": "00:00",
      "end_time": "23:59",
      "timezone": "UTC"
    }
  }')

SCOPE_ID=$(echo "$SCOPE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null)

if [ -z "$SCOPE_ID" ]; then
  echo "âŒ Failed to create scope"
  echo "$SCOPE" | python3 -m json.tool 2>/dev/null || echo "$SCOPE"
  exit 1
fi

echo "âœ… Scope Defined"
echo "   ID: $SCOPE_ID"
echo "$SCOPE" | python3 -m json.tool 2>/dev/null | head -20

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 3: Create Run
echo "ğŸš€ [3/5] Creating pentest run..."
RUN=$(curl -s -X POST "$BFF_URL/projects/$PROJECT_ID/runs" \
  -H "Content-Type: application/json" \
  -d "{
    \"scope_id\": \"$SCOPE_ID\",
    \"policy_version\": \"1.0.0\",
    \"max_iterations\": 50,
    \"created_by\": \"security-team\"
  }")

RUN_ID=$(echo "$RUN" | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null)

if [ -z "$RUN_ID" ]; then
  echo "âŒ Failed to create run"
  echo "$RUN" | python3 -m json.tool 2>/dev/null || echo "$RUN"
  exit 1
fi

echo "âœ… Run Created"
echo "   ID: $RUN_ID"
echo "$RUN" | python3 -m json.tool 2>/dev/null | head -20

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 4: Verify V2 BFF Proxy
echo "ğŸ”„ [4/5] Verifying V2 BFF is proxying correctly..."

echo "   Testing V2 BFF -> V1 proxy for project retrieval..."
V2_PROJECT=$(curl -s "$BFF_URL/projects/$PROJECT_ID")
V1_PROJECT=$(curl -s "$V1_URL/projects/$PROJECT_ID")

if [ "$(echo $V2_PROJECT | grep -c "$PROJECT_ID")" -eq 1 ] && [ "$(echo $V1_PROJECT | grep -c "$PROJECT_ID")" -eq 1 ]; then
  echo "   âœ… Both V2 BFF and V1 API return same project"
else
  echo "   âš ï¸  Response mismatch or error"
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 5: List all resources
echo "ğŸ“‹ [5/5] Listing all resources..."

echo "   Projects:"
curl -s "$BFF_URL/projects" | python3 -m json.tool 2>/dev/null | grep -E '"id"|"name"|"customer_id"' | head -10

echo ""
echo "   Scopes for project:"
curl -s "$BFF_URL/projects/$PROJECT_ID/scopes" | python3 -m json.tool 2>/dev/null | grep -E '"id"|"scope_type"|"targets"' | head -15

echo ""
echo "   Runs for project:"
curl -s "$BFF_URL/projects/$PROJECT_ID/runs" | python3 -m json.tool 2>/dev/null | grep -E '"id"|"status"|"scope_id"' | head -15

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRODUCTION TEST COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Test Summary:"
echo "   âœ… V2 BFF is operational"
echo "   âœ… Proxy to V1 API working"
echo "   âœ… Project creation working"
echo "   âœ… Scope definition working"
echo "   âœ… Run creation working"
echo "   âœ… CRUD operations verified"
echo ""
echo "ğŸ”— Resource IDs:"
echo "   Project: $PROJECT_ID"
echo "   Scope:   $SCOPE_ID"
echo "   Run:     $RUN_ID"
echo ""
echo "ğŸŒ Access Points:"
echo "   V2 BFF: $BFF_URL/projects/$PROJECT_ID"
echo "   V1 API: $V1_URL/projects/$PROJECT_ID"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
