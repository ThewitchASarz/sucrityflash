#!/bin/bash
# SecurityFlash Production Test - Full Pentest Workflow
# Tests V2 BFF -> V1 API integration with real pentest scenario

set -e

API_URL="http://localhost:3001/api/v1"
V1_URL="http://localhost:8000/api/v1"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "SecurityFlash Production Pentest Workflow Test"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Create Project
echo "ğŸ“ Step 1: Creating pentest project..."
PROJECT_RESPONSE=$(curl -s -X POST "$API_URL/projects" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Example.com Security Assessment",
    "description": "Production test pentest of example.com",
    "customer": "Test Customer",
    "policy_version": "v1.0"
  }')

if echo "$PROJECT_RESPONSE" | grep -q "id"; then
  PROJECT_ID=$(echo "$PROJECT_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null || echo "")
  echo "âœ… Project created: $PROJECT_ID"
  echo "$PROJECT_RESPONSE" | python3 -m json.tool 2>/dev/null | head -15
else
  echo "âŒ Failed to create project"
  echo "$PROJECT_RESPONSE"
  exit 1
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 2: Create Scope
echo "ğŸ¯ Step 2: Defining pentest scope..."
SCOPE_RESPONSE=$(curl -s -X POST "$API_URL/projects/$PROJECT_ID/scopes" \
  -H "Content-Type: application/json" \
  -d '{
    "target_domain": "example.com",
    "target_ips": ["93.184.216.34"],
    "allowed_tools": ["nmap", "curl", "dig"],
    "risk_threshold": "medium"
  }')

if echo "$SCOPE_RESPONSE" | grep -q "id"; then
  SCOPE_ID=$(echo "$SCOPE_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null || echo "")
  echo "âœ… Scope created: $SCOPE_ID"
  echo "$SCOPE_RESPONSE" | python3 -m json.tool 2>/dev/null | head -15
else
  echo "âŒ Failed to create scope"
  echo "$SCOPE_RESPONSE"
  exit 1
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 3: Create Pentest Run
echo "ğŸš€ Step 3: Initiating pentest run..."
RUN_RESPONSE=$(curl -s -X POST "$API_URL/projects/$PROJECT_ID/scopes/$SCOPE_ID/runs" \
  -H "Content-Type: application/json" \
  -d '{
    "run_type": "full_scan",
    "initiated_by": "test-user",
    "agent_config": {
      "max_iterations": 10,
      "parallel_actions": 2
    }
  }')

if echo "$RUN_RESPONSE" | grep -q "id"; then
  RUN_ID=$(echo "$RUN_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null || echo "")
  echo "âœ… Pentest run created: $RUN_ID"
  echo "$RUN_RESPONSE" | python3 -m json.tool 2>/dev/null | head -15
else
  echo "âŒ Failed to create run"
  echo "$RUN_RESPONSE"
  exit 1
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 4: Check Run Status
echo "ğŸ“Š Step 4: Checking run status..."
sleep 2
STATUS_RESPONSE=$(curl -s "$API_URL/projects/$PROJECT_ID/scopes/$SCOPE_ID/runs/$RUN_ID")

if echo "$STATUS_RESPONSE" | grep -q "status"; then
  echo "âœ… Run status retrieved"
  echo "$STATUS_RESPONSE" | python3 -m json.tool 2>/dev/null | head -20
else
  echo "âš ï¸  Could not retrieve run status"
  echo "$STATUS_RESPONSE"
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

# Step 5: List Projects (verify CRUD)
echo "ğŸ“‹ Step 5: Listing all projects..."
LIST_RESPONSE=$(curl -s "$API_URL/projects")

if echo "$LIST_RESPONSE" | grep -q "Example.com"; then
  echo "âœ… Projects list retrieved"
  echo "$LIST_RESPONSE" | python3 -m json.tool 2>/dev/null | head -25
else
  echo "âš ï¸  Could not retrieve projects list"
  echo "$LIST_RESPONSE"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Test Results Summary"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… V2 BFF is proxying requests to V1 successfully"
echo "âœ… Project creation working"
echo "âœ… Scope definition working"
echo "âœ… Pentest run initiation working"
echo "âœ… Status retrieval working"
echo ""
echo "ğŸ“Š Test IDs for further testing:"
echo "   Project ID: $PROJECT_ID"
echo "   Scope ID:   $SCOPE_ID"
echo "   Run ID:     $RUN_ID"
echo ""
echo "ğŸ”— Access these via:"
echo "   V2 BFF: http://localhost:3001/api/v1/projects/$PROJECT_ID"
echo "   V1 API: http://localhost:8000/api/v1/projects/$PROJECT_ID"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
