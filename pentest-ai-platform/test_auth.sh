#!/bin/bash

# Test script for authentication endpoints
# Run this after starting the backend server

set -e

API_URL="http://localhost:8000"
echo "Testing Pentest AI Platform Authentication API"
echo "API URL: $API_URL"
echo ""

# Test 1: Health Check
echo "1. Testing health check..."
curl -s "$API_URL/health" | jq .
echo "✓ Health check passed"
echo ""

# Test 2: Register User
echo "2. Registering test user..."
REGISTER_RESPONSE=$(curl -s -X POST "$API_URL/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test.operator@example.com",
    "password": "SecurePassword123!",
    "full_name": "Test Operator",
    "role": "OPERATOR"
  }')

echo "$REGISTER_RESPONSE" | jq .
USER_ID=$(echo "$REGISTER_RESPONSE" | jq -r '.id')
echo "✓ User registered with ID: $USER_ID"
echo ""

# Test 3: Login
echo "3. Logging in..."
LOGIN_RESPONSE=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test.operator@example.com",
    "password": "SecurePassword123!"
  }')

echo "$LOGIN_RESPONSE" | jq .
ACCESS_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.access_token')
echo "✓ Login successful"
echo "Access Token: ${ACCESS_TOKEN:0:50}..."
echo ""

# Test 4: Get Current User
echo "4. Getting current user info..."
curl -s "$API_URL/api/auth/me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
echo "✓ Current user info retrieved"
echo ""

# Test 5: Generate Signing Key
echo "5. Generating RSA signing key pair..."
SIGNING_KEY_RESPONSE=$(curl -s -X POST "$API_URL/api/auth/signing-key" \
  -H "Authorization: Bearer $ACCESS_TOKEN")

echo "$SIGNING_KEY_RESPONSE" | jq 'del(.private_key) | . + {"private_key": "REDACTED (shown only once)"}'
FINGERPRINT=$(echo "$SIGNING_KEY_RESPONSE" | jq -r '.fingerprint')
echo "✓ Signing key generated with fingerprint: ${FINGERPRINT:0:32}..."
echo ""

# Test 6: List Signing Keys
echo "6. Listing signing keys..."
curl -s "$API_URL/api/auth/signing-keys" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
echo "✓ Signing keys listed"
echo ""

# Test 7: Invalid Token
echo "7. Testing invalid token (should fail)..."
INVALID_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" "$API_URL/api/auth/me" \
  -H "Authorization: Bearer invalid_token_here")

HTTP_CODE=$(echo "$INVALID_RESPONSE" | grep "HTTP_CODE" | cut -d':' -f2)
if [ "$HTTP_CODE" = "401" ]; then
  echo "✓ Invalid token correctly rejected (401)"
else
  echo "✗ Unexpected response code: $HTTP_CODE"
fi
echo ""

echo "================================"
echo "All authentication tests passed!"
echo "================================"
echo ""
echo "Summary:"
echo "- User registered: test.operator@example.com"
echo "- User ID: $USER_ID"
echo "- Access token obtained: ${ACCESS_TOKEN:0:50}..."
echo "- Signing key fingerprint: ${FINGERPRINT:0:32}..."
echo ""
echo "Next steps:"
echo "1. Use this access token to test other endpoints"
echo "2. Save the private key from step 5 (it's only shown once)"
echo "3. Use the signing key to sign scope locks and approvals"
