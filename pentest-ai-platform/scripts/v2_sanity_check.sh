#!/bin/bash
# V2 Sanity Check Script
# Ensures V2 is clean and properly integrated with SecurityFlash V1

set -e

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

echo "================================"
echo "V2 Sanity Check"
echo "================================"
echo ""

FAILED=0

# Check 1: No placeholder "..." code
echo "[1/7] Checking for placeholder '...' code..."
if grep -r "^\s*\.\.\.\s*$" --include="*.py" backend/ 2>/dev/null; then
    echo "❌ FAIL: Found placeholder '...' code"
    FAILED=1
else
    echo "✅ PASS: No placeholder '...' code found"
fi
echo ""

# Check 2: No venv directories
echo "[2/7] Checking for venv directories..."
if find . -name "venv" -o -name ".venv" | grep -q .; then
    echo "❌ FAIL: Found venv directories"
    find . -name "venv" -o -name ".venv"
    FAILED=1
else
    echo "✅ PASS: No venv directories found"
fi
echo ""

# Check 3: No subprocess usage in backend (except tests)
echo "[3/7] Checking for subprocess usage..."
if grep -r "import subprocess" --include="*.py" backend/ --exclude-dir=tests 2>/dev/null | grep -v test_ | grep -q .; then
    echo "❌ FAIL: Found subprocess usage (V2 must not execute tools)"
    grep -r "import subprocess" --include="*.py" backend/ --exclude-dir=tests | grep -v test_
    FAILED=1
else
    echo "✅ PASS: No subprocess usage found"
fi
echo ""

# Check 4: SecurityFlash API URL env var is documented
echo "[4/7] Checking for SECURITYFLASH_API_URL documentation..."
if grep -q "SECURITYFLASH_API_URL" docs/V2_SECURITYFLASH_INTEGRATION.md; then
    echo "✅ PASS: SECURITYFLASH_API_URL is documented"
else
    echo "❌ FAIL: SECURITYFLASH_API_URL not documented"
    FAILED=1
fi
echo ""

# Check 5: SecurityFlash client exists
echo "[5/7] Checking for SecurityFlash HTTP client..."
if [ -f "backend/clients/securityflash_client.py" ]; then
    echo "✅ PASS: SecurityFlash client exists"
else
    echo "❌ FAIL: SecurityFlash client not found"
    FAILED=1
fi
echo ""

# Check 6: No direct evidence storage in V2
echo "[6/7] Checking for direct evidence storage..."
if grep -r "Evidence(" --include="*.py" backend/api/ 2>/dev/null | grep -v "get_evidence\|query_evidence\|Evidence):" | grep -q .; then
    echo "❌ FAIL: Found direct evidence creation (must use V1 API)"
    FAILED=1
else
    echo "✅ PASS: No direct evidence storage found"
fi
echo ""

# Check 7: No approval token generation in V2
echo "[7/7] Checking for approval token generation..."
if grep -r "generate_approval_token\|create_approval_token" --include="*.py" backend/ 2>/dev/null | grep -q .; then
    echo "❌ FAIL: Found approval token generation (must use V1 API)"
    FAILED=1
else
    echo "✅ PASS: No approval token generation found"
fi
echo ""

# Summary
echo "================================"
if [ $FAILED -eq 0 ]; then
    echo "✅ ALL CHECKS PASSED"
    echo "V2 is clean and properly integrated with V1"
    echo "================================"
    exit 0
else
    echo "❌ SOME CHECKS FAILED"
    echo "Fix the issues above before deploying"
    echo "================================"
    exit 1
fi
