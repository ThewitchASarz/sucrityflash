#!/bin/bash
#
# V2 UI Smoke Test - End-to-End Integration Test
# Tests all critical workflows through V2 BFF proxy
#
# Usage: ./scripts/v2_ui_smoke.sh
#
# Prerequisites:
# - Docker containers running (V1 API, V2 BFF, PostgreSQL, Redis, Worker)
# - jq installed for JSON parsing
#

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
V2_BFF_URL="http://localhost:3001"
V1_API_URL="http://localhost:8000"
TOKEN="demo-token"

# Test counters
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

# Functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

assert_http_status() {
    local expected=$1
    local actual=$2
    local test_name=$3

    TESTS_RUN=$((TESTS_RUN + 1))

    if [ "$actual" -eq "$expected" ]; then
        log_info "✓ $test_name (HTTP $actual)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        log_error "✗ $test_name (Expected HTTP $expected, got $actual)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        return 1
    fi
}

assert_contains() {
    local expected=$1
    local actual=$2
    local test_name=$3

    TESTS_RUN=$((TESTS_RUN + 1))

    if echo "$actual" | grep -q "$expected"; then
        log_info "✓ $test_name"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        log_error "✗ $test_name (Expected to contain: $expected)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        return 1
    fi
}

# Check prerequisites
log_info "Checking prerequisites..."

if ! command -v jq &> /dev/null; then
    log_error "jq is not installed. Install with: brew install jq"
    exit 1
fi

if ! command -v curl &> /dev/null; then
    log_error "curl is not installed"
    exit 1
fi

log_info "Prerequisites OK"
echo ""

# ============================================================================
# Test 1: Health Checks
# ============================================================================
log_info "=== Test 1: Health Checks ==="

# V2 BFF Health
response=$(curl -s -w "\n%{http_code}" "$V2_BFF_URL/health")
body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)
assert_http_status 200 "$status" "V2 BFF health check"
assert_contains "V2 BFF" "$body" "V2 BFF health response contains app name"

# V1 API Health
response=$(curl -s -w "\n%{http_code}" "$V1_API_URL/health")
status=$(echo "$response" | tail -n 1)
assert_http_status 200 "$status" "V1 API health check"

echo ""

# ============================================================================
# Test 2: Create Project
# ============================================================================
log_info "=== Test 2: Create Project ==="

project_data=$(cat <<EOF
{
  "name": "Smoke Test Project $(date +%s)",
  "customer_name": "Acme Corp",
  "description": "Automated smoke test"
}
EOF
)

response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$project_data" \
    "$V2_BFF_URL/api/v1/projects")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 201 "$status" "Create project via V2 BFF"

if [ "$status" -eq 201 ]; then
    PROJECT_ID=$(echo "$body" | jq -r '.id')
    log_info "Created project ID: $PROJECT_ID"
else
    log_error "Failed to create project. Response: $body"
    exit 1
fi

echo ""

# ============================================================================
# Test 3: List Projects
# ============================================================================
log_info "=== Test 3: List Projects ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/projects")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "List projects via V2 BFF"
assert_contains "$PROJECT_ID" "$body" "Projects list contains created project"

echo ""

# ============================================================================
# Test 4: Create Scope
# ============================================================================
log_info "=== Test 4: Create Scope ==="

scope_data=$(cat <<EOF
{
  "scope_type": "web_app",
  "targets": [
    {"type": "domain", "value": "example.com", "criticality": "HIGH"},
    {"type": "ip", "value": "192.168.1.100", "criticality": "MEDIUM"}
  ],
  "excluded_targets": [],
  "attack_vectors_allowed": ["reconnaissance", "vulnerability_scanning"],
  "attack_vectors_prohibited": ["social_engineering", "dos"],
  "approved_tools": ["nmap", "burpsuite"]
}
EOF
)

response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$scope_data" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID/scopes")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 201 "$status" "Create scope for project"

if [ "$status" -eq 201 ]; then
    SCOPE_ID=$(echo "$body" | jq -r '.id')
    log_info "Created scope ID: $SCOPE_ID"
else
    log_error "Failed to create scope. Response: $body"
    exit 1
fi

echo ""

# ============================================================================
# Test 5: Get Scope
# ============================================================================
log_info "=== Test 5: Get Scope ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID/scopes/$SCOPE_ID")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "Get scope by ID"
assert_contains "example.com" "$body" "Scope contains target domain"

echo ""

# ============================================================================
# Test 6: Create Run
# ============================================================================
log_info "=== Test 6: Create Run ==="

run_data=$(cat <<EOF
{
  "scope_id": "$SCOPE_ID"
}
EOF
)

response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$run_data" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID/runs")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 201 "$status" "Create run for scope"

if [ "$status" -eq 201 ]; then
    RUN_ID=$(echo "$body" | jq -r '.id')
    log_info "Created run ID: $RUN_ID"
else
    log_error "Failed to create run. Response: $body"
    exit 1
fi

echo ""

# ============================================================================
# Test 7: Start Run
# ============================================================================
log_info "=== Test 7: Start Run ==="

response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/runs/$RUN_ID/start")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "Start run execution"

echo ""

# ============================================================================
# Test 8: Get Run Status
# ============================================================================
log_info "=== Test 8: Get Run Status ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/runs/$RUN_ID")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "Get run status"

run_status=$(echo "$body" | jq -r '.status')
log_info "Run status: $run_status"

echo ""

# ============================================================================
# Test 9: Get Run Stats (Proof of Work)
# ============================================================================
log_info "=== Test 9: Get Run Stats ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/runs/$RUN_ID/stats")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

# Accept 200 or 404 (endpoint may not be implemented in V1 yet)
if [ "$status" -eq 200 ]; then
    assert_http_status 200 "$status" "Get run stats (proof of work)"
    log_info "Stats: $(echo "$body" | jq -c '.')"
elif [ "$status" -eq 404 ]; then
    log_warn "Stats endpoint not implemented in V1 API yet (404)"
    TESTS_RUN=$((TESTS_RUN + 1))
else
    assert_http_status 200 "$status" "Get run stats"
fi

echo ""

# ============================================================================
# Test 10: Get Run Timeline
# ============================================================================
log_info "=== Test 10: Get Run Timeline ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/runs/$RUN_ID/timeline")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

# Accept 200 or 404 (endpoint may not be implemented in V1 yet)
if [ "$status" -eq 200 ]; then
    assert_http_status 200 "$status" "Get run timeline"
    log_info "Timeline events: $(echo "$body" | jq -c '. | length')"
elif [ "$status" -eq 404 ]; then
    log_warn "Timeline endpoint not implemented in V1 API yet (404)"
    TESTS_RUN=$((TESTS_RUN + 1))
else
    assert_http_status 200 "$status" "Get run timeline"
fi

echo ""

# ============================================================================
# Test 11: List Runs for Project
# ============================================================================
log_info "=== Test 11: List Runs for Project ==="

response=$(curl -s -w "\n%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID/runs")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "List runs for project"
assert_contains "$RUN_ID" "$body" "Runs list contains created run"

echo ""

# ============================================================================
# Test 12: API Documentation Endpoints
# ============================================================================
log_info "=== Test 12: API Documentation ==="

# V2 BFF Docs
response=$(curl -s -w "\n%{http_code}" "$V2_BFF_URL/docs")
status=$(echo "$response" | tail -n 1)
assert_http_status 200 "$status" "V2 BFF /docs endpoint"

# V1 API Docs
response=$(curl -s -w "\n%{http_code}" "$V1_API_URL/docs")
status=$(echo "$response" | tail -n 1)
assert_http_status 200 "$status" "V1 API /docs endpoint"

echo ""

# ============================================================================
# Test 13: Update Project
# ============================================================================
log_info "=== Test 13: Update Project ==="

update_data=$(cat <<EOF
{
  "name": "Updated Smoke Test Project"
}
EOF
)

response=$(curl -s -w "\n%{http_code}" -X PATCH \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$update_data" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID")

body=$(echo "$response" | head -n -1)
status=$(echo "$response" | tail -n 1)

assert_http_status 200 "$status" "Update project name"
assert_contains "Updated Smoke Test Project" "$body" "Project name updated"

echo ""

# ============================================================================
# Test 14: Delete Project (Cleanup)
# ============================================================================
log_info "=== Test 14: Delete Project (Cleanup) ==="

response=$(curl -s -w "\n%{http_code}" -X DELETE \
    -H "Authorization: Bearer $TOKEN" \
    "$V2_BFF_URL/api/v1/projects/$PROJECT_ID")

status=$(echo "$response" | tail -n 1)

assert_http_status 204 "$status" "Delete project"

echo ""

# ============================================================================
# Summary
# ============================================================================
echo "============================================"
echo "Smoke Test Summary"
echo "============================================"
echo "Tests run:    $TESTS_RUN"
echo "Tests passed: $TESTS_PASSED"
echo "Tests failed: $TESTS_FAILED"
echo "============================================"

if [ "$TESTS_FAILED" -eq 0 ]; then
    log_info "✓ All smoke tests passed!"
    exit 0
else
    log_error "✗ Some tests failed"
    exit 1
fi
