# SecurityFlash V2 MVP - Quick Start Guide

## Prerequisites

- Python 3.11+
- PostgreSQL 14+
- Redis 7+
- Virtual environment activated

## Installation

```bash
cd pentest-ai-platform/backend

# Install dependencies (if not already installed)
pip install -r requirements.txt

# Install additional V2 dependencies
pip install redis pydantic
```

## Database Setup

```bash
# Apply V2 migrations
alembic upgrade head

# Verify migration applied
psql -d pentest_db -c "SELECT * FROM alembic_version;"
```

## Testing V2 Implementation

### Test 1: Policy Engine & Tool Validation

```bash
python test_v2_implementation.py
```

**Expected Output:**
```
✅ Stage 1 tools allowed (httpx, nmap, dnsx, subfinder, katana, ffuf)
✅ Stage 2 tools rejected (nuclei, sqlmap, nikto)
✅ FlagSchema validators working
✅ JWT approval tokens issued and verified
```

### Test 2: API Integration

```bash
python test_v2_api.py
```

**Expected Output:**
```
✅ /api/v1/auth/token endpoint exists
✅ /api/v1/approvals endpoint exists
✅ Policy Engine integrated
✅ Redis Streams service ready
✅ Audit service ready
```

## Starting the Control Plane

### Terminal 1: PostgreSQL
```bash
# If not already running
pg_ctl -D /usr/local/var/postgres start
```

### Terminal 2: Redis
```bash
# If not already running
redis-server --daemonize yes

# Verify
redis-cli ping  # Should return PONG
```

### Terminal 3: FastAPI Control Plane
```bash
cd backend
source venv/bin/activate
python main.py
```

**Access:**
- API: http://localhost:8000
- Docs: http://localhost:8000/docs
- Health: http://localhost:8000/health

## Testing with curl

### 1. Health Check
```bash
curl http://localhost:8000/health
```

### 2. Register Test User
```bash
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testpassword",
    "full_name": "Test User",
    "role": "OPERATOR"
  }'
```

### 3. Get JWT Token (NextAuth.js format)
```bash
curl -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=test@example.com&password=testpassword"
```

### 4. Test Policy Engine (Manual)
```bash
python -c "
from services.policy_engine import policy_engine
import uuid

# Test tool validation
is_valid, error = policy_engine.validate_tool_allowlist('nmap')
print(f'Nmap allowed: {is_valid}')

is_valid, error = policy_engine.validate_tool_allowlist('nuclei')
print(f'Nuclei rejected: {not is_valid}')

# Test JWT token
token = policy_engine.issue_approval_token(
    action_id=uuid.uuid4(),
    run_id=uuid.uuid4(),
    method='nmap',
    flags={'target': 'example.com'},
    approved_by=uuid.uuid4()
)
print(f'Token: {token[:50]}...')

claims = policy_engine.verify_approval_token(token)
print(f'Verified: {claims is not None}')
"
```

## V2 Architecture Verification

### 1. Verify Redis Streams Structure

```bash
# Check stream exists (after approval event)
redis-cli XINFO STREAM control_plane_events

# Check consumer groups
redis-cli XINFO GROUPS control_plane_events
```

### 2. Verify Database Schema

```bash
psql -d pentest_db

-- Check findings table has validation fields
\d findings

-- Check new V2 tables
\d report_jobs
\d audit_bundle_jobs
\d integration_configs
```

### 3. Verify Tool Allowlist

```bash
python -c "
from tools.tool_allowlist import AllowedToolV2MVP

print('Allowed tools:', AllowedToolV2MVP.get_allowed_tools())
print('Is nmap allowed?', AllowedToolV2MVP.is_allowed('nmap'))
print('Is nuclei allowed?', AllowedToolV2MVP.is_allowed('nuclei'))
"
```

## Troubleshooting

### Issue: Redis connection refused
```bash
# Start Redis
redis-server --daemonize yes

# Or check if running
ps aux | grep redis-server
```

### Issue: PostgreSQL connection refused
```bash
# Check PostgreSQL status
pg_ctl -D /usr/local/var/postgres status

# Start if not running
pg_ctl -D /usr/local/var/postgres start
```

### Issue: Module not found
```bash
# Reinstall dependencies
pip install -r requirements.txt
pip install redis pydantic jose python-multipart
```

### Issue: Migration failed
```bash
# Check current migration version
alembic current

# Downgrade and re-apply
alembic downgrade -1
alembic upgrade head
```

## What's Working (V2)

✅ **Policy Engine**
- Stage 1 tool allowlist (httpx, nmap, dnsx, subfinder, katana, ffuf)
- Stage 2 tool rejection (nuclei, sqlmap, nikto)
- JWT approval token issuance
- ActionSpec validation

✅ **FlagSchema Validators**
- Per-tool flag validation
- Domain/CIDR/port regex enforcement
- Pydantic type safety

✅ **Redis Streams Service**
- Consumer Groups (agent_group, worker_group, control_plane_group)
- XREADGROUP, XACK, XCLAIM support
- Event publishing (action_approved, action_rejected)

✅ **Audit Service**
- UI action logging
- Approval/rejection tracking
- Evidence delete attempt logging

✅ **Authentication**
- POST /api/v1/auth/token (NextAuth.js)
- JWT middleware
- RBAC enforcement

✅ **Approvals API**
- Integrated with Policy Engine
- Publishes to Redis Streams
- Issues JWT approval tokens
- Audit logging

## What's Pending (V2)

⏸️ **Worker Runtime**
- Continuous service implementation
- Redis Streams consumer
- JWT token validation
- Subprocess execution

⏸️ **Finding Validation**
- ValidatorAgent implementation
- Validation workflow
- Report filtering

⏸️ **Reports & Audit Bundles**
- HTML/PDF generation
- OWASP mapping
- Compliance exports

⏸️ **Evidence Immutability**
- DELETE endpoint 403 enforcement

⏸️ **Integrations & UI**
- Slack/Jira/webhooks
- Next.js UI
- NextAuth.js integration

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                     Control Plane (FastAPI)                  │
│                                                               │
│  ┌────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   Policy   │  │    Redis     │  │    Audit     │        │
│  │   Engine   │  │   Streams    │  │   Service    │        │
│  └────────────┘  └──────────────┘  └──────────────┘        │
│                                                               │
│  /api/v1/auth/token    ← NextAuth.js                        │
│  /api/v1/approvals     ← UI                                 │
│  /api/v1/runs          ← UI                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Redis Streams
                            │ (control_plane_events)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Agent Runtime (Separate)                  │
│                                                               │
│  • Consumes ActionSpecs via XREADGROUP                      │
│  • Proposes next actions (reasoning only)                   │
│  • Publishes to agent_events stream                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Redis Streams
                            │ (agent_events)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Worker Runtime (Separate)                  │
│                                                               │
│  • Validates JWT approval token                             │
│  • Executes tools (shell=False)                             │
│  • Enforces tool allowlist (3 layers)                       │
│  • Publishes results to worker_events                       │
└─────────────────────────────────────────────────────────────┘
```

## Three-Layer Tool Enforcement

```
Layer 1: Policy Engine (service)
         ↓
         validate_tool_allowlist("nmap")
         ✅ PASS (Stage 1)

Layer 2: Worker Runtime Enum (type safety)
         ↓
         AllowedToolV2MVP.is_allowed("nmap")
         ✅ PASS

Layer 3: Subprocess Validation (runtime)
         ↓
         subprocess.run(["nmap", ...], shell=False)
         ✅ PASS (tool exists, flags valid)
```

## Support

For issues or questions:
1. Check V2_TEST_RESULTS.md for test status
2. Check V2_IMPLEMENTATION_TASKS.md for task checklist
3. Check V2_BOOTSTRAP_NOTES.md for architecture details
4. Review SecurityFlash-V2-Plan-CORRECTED.md for spec
