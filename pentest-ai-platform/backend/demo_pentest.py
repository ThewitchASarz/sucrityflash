#!/usr/bin/env python3
"""
Demo script to test the full AI pentest workflow end-to-end.
This demonstrates the AI agents conducting an autonomous pentest.
"""
import asyncio
import httpx
from datetime import datetime

API_BASE = "http://localhost:8000"

class PentestDemo:
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0)
        self.token = None
        self.user_id = None
        self.project_id = None
        self.scope_id = None
        self.plan_id = None
        self.run_id = None

    async def register_and_login(self):
        """Register a test user and login."""
        print("\nüîê Step 1: User Registration & Login")
        print("=" * 60)

        # Register
        email = f"pentester-{datetime.now().timestamp()}@test.com"
        register_data = {
            "email": email,
            "password": "SecurePass123!",
            "full_name": "AI Pentester",
            "role": "COORDINATOR"
        }

        try:
            response = await self.client.post(
                f"{API_BASE}/api/auth/register",
                json=register_data
            )
            if response.status_code == 200:
                print(f"‚úÖ User registered: {email}")
            else:
                print(f"‚ö†Ô∏è  Registration response: {response.status_code}")
        except Exception as e:
            print(f"‚ùå Registration failed: {e}")
            return False

        # Login
        try:
            response = await self.client.post(
                f"{API_BASE}/api/auth/login",
                json={"email": email, "password": "SecurePass123!"}
            )
            if response.status_code == 200:
                data = response.json()
                self.token = data["access_token"]
                self.user_id = data["user"]["id"]
                self.client.headers["Authorization"] = f"Bearer {self.token}"
                print(f"‚úÖ Logged in successfully")
                print(f"   User ID: {self.user_id}")
                return True
            else:
                print(f"‚ùå Login failed: {response.status_code}")
                print(response.text)
                return False
        except Exception as e:
            print(f"‚ùå Login error: {e}")
            return False

    async def create_project(self):
        """Create a pentest project."""
        print("\nüìã Step 2: Create Pentest Project")
        print("=" * 60)

        project_data = {
            "name": "ACME Corp Web Application Pentest",
            "customer_name": "ACME Corporation",
            "description": "Comprehensive security assessment of ACME's e-commerce platform"
        }

        try:
            response = await self.client.post(
                f"{API_BASE}/api/projects",
                json=project_data
            )
            if response.status_code == 200:
                data = response.json()
                self.project_id = data["id"]
                print(f"‚úÖ Project created: {data['name']}")
                print(f"   Project ID: {self.project_id}")
                print(f"   Customer: {data['customer_name']}")
                print(f"   Status: {data['status']}")
                return True
            else:
                print(f"‚ùå Failed: {response.status_code} - {response.text}")
                return False
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def define_scope(self):
        """Define the pentest scope."""
        print("\nüéØ Step 3: Define Scope (Rules of Engagement)")
        print("=" * 60)

        scope_data = {
            "project_id": self.project_id,
            "target_systems": [
                {"type": "web", "address": "https://acme.example.com", "description": "Main web application"},
                {"type": "api", "address": "https://api.acme.example.com", "description": "REST API"},
                {"type": "web", "address": "https://admin.acme.example.com", "description": "Admin portal"}
            ],
            "excluded_systems": [
                {"address": "https://payroll.acme.example.com", "reason": "Third-party payroll system - out of scope"}
            ],
            "forbidden_methods": ["dos", "social_engineering", "physical_access"],
            "roe": {
                "testing_window": "Monday-Friday 9am-5pm EST",
                "notification_required": True,
                "backup_required": True,
                "data_handling": "No PII extraction allowed"
            }
        }

        try:
            response = await self.client.post(
                f"{API_BASE}/api/scopes",
                json=scope_data
            )
            if response.status_code == 200:
                data = response.json()
                self.scope_id = data["id"]
                print(f"‚úÖ Scope defined")
                print(f"   Scope ID: {self.scope_id}")
                print(f"   Target systems: {len(data['target_systems'])}")
                print(f"   Excluded systems: {len(data['excluded_systems'])}")
                print(f"   Forbidden methods: {', '.join(data['forbidden_methods'])}")
                return True
            else:
                print(f"‚ùå Failed: {response.status_code} - {response.text}")
                return False
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def generate_test_plan(self):
        """Use AI Planner Agent to generate test plan."""
        print("\nü§ñ Step 4: AI Planner Agent - Generate Test Plan")
        print("=" * 60)
        print("AI Agent analyzing scope and generating comprehensive test plan...")

        try:
            response = await self.client.post(
                f"{API_BASE}/api/test-plans/generate",
                json={"scope_id": self.scope_id}
            )
            if response.status_code == 200:
                data = response.json()
                self.plan_id = data["id"]
                print(f"‚úÖ AI-generated test plan created")
                print(f"   Plan ID: {self.plan_id}")
                print(f"   Generated by: {data['generated_by']} (AI Agent)")
                print(f"   Total stages: {len(data['stages'])}")

                # Show plan details
                for i, stage in enumerate(data['stages'], 1):
                    print(f"\n   Stage {i}: {stage['name']}")
                    print(f"   ‚îî‚îÄ Risk Level: {stage['risk_level']}")
                    print(f"   ‚îî‚îÄ Actions: {len(stage['actions'])}")
                    for action in stage['actions'][:3]:  # Show first 3 actions
                        print(f"      ‚Ä¢ {action['description']}")
                    if len(stage['actions']) > 3:
                        print(f"      ... and {len(stage['actions']) - 3} more actions")

                if 'risk_summary' in data:
                    print(f"\n   Risk Summary:")
                    for risk, count in data['risk_summary'].items():
                        print(f"   ‚îî‚îÄ {risk}: {count} actions")

                return True
            else:
                print(f"‚ùå Failed: {response.status_code} - {response.text}")
                return False
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def start_pentest_run(self):
        """Start an autonomous pentest run."""
        print("\nüöÄ Step 5: Start Autonomous Pentest Run")
        print("=" * 60)
        print("Starting AI-driven autonomous pentest execution...")

        try:
            response = await self.client.post(
                f"{API_BASE}/api/runs",
                json={"plan_id": self.plan_id}
            )
            if response.status_code == 200:
                data = response.json()
                self.run_id = data["id"]
                print(f"‚úÖ Pentest run started")
                print(f"   Run ID: {self.run_id}")
                print(f"   Status: {data['status']}")
                print(f"   Started at: {data['started_at']}")
                print("\n   ü§ñ AI Agents are now:")
                print("   ‚Ä¢ Analyzing targets")
                print("   ‚Ä¢ Executing security tests")
                print("   ‚Ä¢ Requesting approvals for high-risk actions")
                print("   ‚Ä¢ Collecting evidence")
                print("   ‚Ä¢ Identifying vulnerabilities")
                return True
            else:
                print(f"‚ùå Failed: {response.status_code} - {response.text}")
                return False
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def check_run_status(self):
        """Check the status of the pentest run."""
        print("\nüìä Step 6: Monitor Run Status")
        print("=" * 60)

        try:
            response = await self.client.get(f"{API_BASE}/api/runs/{self.run_id}")
            if response.status_code == 200:
                data = response.json()
                print(f"Run Status: {data['status']}")
                print(f"Started: {data.get('started_at', 'N/A')}")
                print(f"Completed: {data.get('completed_at', 'In Progress')}")
                return True
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def view_findings(self):
        """View discovered findings."""
        print("\nüîç Step 7: View Discovered Findings")
        print("=" * 60)

        try:
            response = await self.client.get(f"{API_BASE}/api/findings?run_id={self.run_id}")
            if response.status_code == 200:
                findings = response.json()
                print(f"‚úÖ Retrieved {len(findings)} findings")

                if findings:
                    for i, finding in enumerate(findings, 1):
                        print(f"\n   Finding #{i}:")
                        print(f"   ‚îî‚îÄ Title: {finding['title']}")
                        print(f"   ‚îî‚îÄ Severity: {finding['severity']}")
                        print(f"   ‚îî‚îÄ CVSS Score: {finding.get('cvss_score', 'N/A')}")
                        print(f"   ‚îî‚îÄ Description: {finding['description'][:100]}...")
                else:
                    print("   (No findings yet - run may still be in progress)")
                return True
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def view_evidence_chain(self):
        """View evidence chain."""
        print("\nüîó Step 8: View Evidence Chain (Immutable Audit Trail)")
        print("=" * 60)

        try:
            response = await self.client.get(f"{API_BASE}/api/evidence?run_id={self.run_id}")
            if response.status_code == 200:
                evidence = response.json()
                print(f"‚úÖ Retrieved {len(evidence)} evidence items")

                if evidence:
                    for i, item in enumerate(evidence[:5], 1):  # Show first 5
                        print(f"\n   Evidence #{i}:")
                        print(f"   ‚îî‚îÄ Type: {item['evidence_type']}")
                        print(f"   ‚îî‚îÄ Actor: {item['created_by_actor_type']} ({item['created_by_actor_id']})")
                        print(f"   ‚îî‚îÄ Hash: {item['content_hash'][:16]}...")
                        print(f"   ‚îî‚îÄ Signed: ‚úì")
                        print(f"   ‚îî‚îÄ Chain Link: {item['prior_evidence_hash'][:16] if item['prior_evidence_hash'] else 'Genesis'}...")

                    if len(evidence) > 5:
                        print(f"\n   ... and {len(evidence) - 5} more evidence items")
                else:
                    print("   (No evidence yet)")
                return True
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def verify_evidence_integrity(self):
        """Verify evidence chain integrity."""
        print("\nüîê Step 9: Verify Evidence Chain Integrity")
        print("=" * 60)

        try:
            response = await self.client.post(
                f"{API_BASE}/api/evidence/verify-chain/{self.run_id}"
            )
            if response.status_code == 200:
                data = response.json()
                print(f"‚úÖ Evidence chain verification: {data['status']}")
                print(f"   Total items: {data['total_items']}")
                print(f"   Verified: {data['verified_items']}")
                print(f"   Failed: {data['failed_items']}")

                if data['status'] == 'valid':
                    print(f"\n   üõ°Ô∏è  Evidence chain is cryptographically secure!")
                    print(f"   All evidence items are:")
                    print(f"   ‚Ä¢ Hash-chained (tamper-evident)")
                    print(f"   ‚Ä¢ Digitally signed")
                    print(f"   ‚Ä¢ Immutable (write-once)")
                return True
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def view_audit_log(self):
        """View audit log."""
        print("\nüìú Step 10: View Audit Log")
        print("=" * 60)

        try:
            response = await self.client.get(f"{API_BASE}/api/audit?limit=10")
            if response.status_code == 200:
                logs = response.json()
                print(f"‚úÖ Retrieved {len(logs)} audit log entries")

                for i, log in enumerate(logs[:10], 1):
                    print(f"\n   [{log['timestamp']}]")
                    print(f"   {log['actor_type']}/{log['actor_id']} -> {log['action']}")
                    print(f"   Resource: {log['resource_type']}/{log['resource_id'][:8]}...")

                return True
        except Exception as e:
            print(f"‚ùå Error: {e}")
            return False

    async def run_demo(self):
        """Run the complete demo."""
        print("\n" + "=" * 60)
        print("ü§ñ AI PENTEST PLATFORM - AUTONOMOUS PENTEST DEMO")
        print("=" * 60)
        print("\nThis demonstrates the full AI-powered pentest workflow:")
        print("‚Ä¢ AI Planner Agent generates test plans")
        print("‚Ä¢ AI Triage Agent evaluates findings")
        print("‚Ä¢ AI Reporter Agent creates reports")
        print("‚Ä¢ Background Orchestrator manages execution")
        print("‚Ä¢ Human approval gates for high-risk actions")
        print("‚Ä¢ Cryptographic evidence chain")
        print("‚Ä¢ Complete audit trail")

        try:
            if not await self.register_and_login():
                return

            if not await self.create_project():
                return

            if not await self.define_scope():
                return

            if not await self.generate_test_plan():
                return

            if not await self.start_pentest_run():
                return

            # Wait a bit for background processing
            print("\n‚è≥ Waiting 3 seconds for AI agents to process...")
            await asyncio.sleep(3)

            await self.check_run_status()
            await self.view_findings()
            await self.view_evidence_chain()
            await self.verify_evidence_integrity()
            await self.view_audit_log()

            print("\n" + "=" * 60)
            print("‚úÖ DEMO COMPLETE!")
            print("=" * 60)
            print("\nüéØ What we demonstrated:")
            print("1. ‚úì User authentication & RBAC")
            print("2. ‚úì Project & scope management")
            print("3. ‚úì AI-powered test plan generation (Planner Agent)")
            print("4. ‚úì Autonomous pentest execution")
            print("5. ‚úì Finding discovery & triage")
            print("6. ‚úì Cryptographic evidence chain")
            print("7. ‚úì Chain integrity verification")
            print("8. ‚úì Comprehensive audit logging")
            print("\nüî• The AI agents are running autonomously in the background!")
            print("   Check http://localhost:8000/docs to explore more features.")

        except Exception as e:
            print(f"\n‚ùå Demo failed: {e}")
        finally:
            await self.client.aclose()


if __name__ == "__main__":
    demo = PentestDemo()
    asyncio.run(demo.run_demo())
