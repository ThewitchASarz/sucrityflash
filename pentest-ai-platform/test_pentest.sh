#!/bin/bash
# Simple test script for the AI Pentest Platform

API="http://localhost:8000"

echo "============================================================"
echo "ðŸ¤– AI PENTEST PLATFORM - LIVE TEST"
echo "============================================================"
echo ""

# Use the existing test user from before
EMAIL="admin@test.com"
PASS="password123"

echo "ðŸ” Step 1: Login"
echo "============================================================"
TOKEN_RESPONSE=$(curl -s -X POST "$API/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\"}")

# Extract token (simple grep since jq might not be available)
TOKEN=$(echo $TOKEN_RESPONSE | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

if [ -z "$TOKEN" ]; then
    echo "âŒ Login failed. Creating new user..."
    
    # Try with a fresh user
    TIMESTAMP=$(date +%s)
    EMAIL="pentester${TIMESTAMP}@test.com"
    PASS="TestPass123!"
    
    echo "Registering: $EMAIL"
    curl -s -X POST "$API/api/auth/register" \
      -H "Content-Type: application/json" \
      -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"full_name\":\"Test Pentester\",\"role\":\"COORDINATOR\"}"
    
    echo ""
    echo "Logging in..."
    TOKEN_RESPONSE=$(curl -s -X POST "$API/api/auth/login" \
      -H "Content-Type: application/json" \
      -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\"}")
    
    TOKEN=$(echo $TOKEN_RESPONSE | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
fi

if [ -z "$TOKEN" ]; then
    echo "âŒ Could not authenticate"
    exit 1
fi

echo "âœ… Authenticated successfully"
echo ""

echo "ðŸ“‹ Step 2: Create Project"
echo "============================================================"
PROJECT_RESPONSE=$(curl -s -X POST "$API/api/projects" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"ACME Corp Pentest","customer_name":"ACME Corporation","description":"Web app security assessment"}')

echo "$PROJECT_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$PROJECT_RESPONSE"
PROJECT_ID=$(echo $PROJECT_RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
echo "âœ… Project ID: $PROJECT_ID"
echo ""

echo "ðŸŽ¯ Step 3: Define Scope"
echo "============================================================"
SCOPE_RESPONSE=$(curl -s -X POST "$API/api/scopes" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"project_id\":\"$PROJECT_ID\",\"target_systems\":[{\"type\":\"web\",\"address\":\"https://acme.example.com\",\"description\":\"Main site\"}],\"excluded_systems\":[],\"forbidden_methods\":[\"dos\"],\"roe\":{\"testing_window\":\"9am-5pm\"}}")

echo "$SCOPE_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$SCOPE_RESPONSE"
SCOPE_ID=$(echo $SCOPE_RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
echo "âœ… Scope ID: $SCOPE_ID"
echo ""

echo "ðŸ¤– Step 4: AI Planner Agent - Generate Test Plan"
echo "============================================================"
echo "AI Agent analyzing targets and generating test plan..."
PLAN_RESPONSE=$(curl -s -X POST "$API/api/test-plans/generate" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"scope_id\":\"$SCOPE_ID\"}")

echo "$PLAN_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$PLAN_RESPONSE"
PLAN_ID=$(echo $PLAN_RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
echo "âœ… Test Plan ID: $PLAN_ID"
echo ""

echo "ðŸš€ Step 5: Start Autonomous Pentest Run"
echo "============================================================"
echo "Starting AI-driven autonomous execution..."
RUN_RESPONSE=$(curl -s -X POST "$API/api/runs" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"plan_id\":\"$PLAN_ID\"}")

echo "$RUN_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RUN_RESPONSE"
RUN_ID=$(echo $RUN_RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
echo "âœ… Run ID: $RUN_ID"
echo "ðŸ¤– AI Agents are now executing tests autonomously!"
echo ""

echo "â³ Waiting for AI agents to process..."
sleep 5
echo ""

echo "ðŸ“Š Step 6: Check Run Status"
echo "============================================================"
curl -s -X GET "$API/api/runs/$RUN_ID" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool 2>/dev/null
echo ""

echo "ðŸ” Step 7: View Findings"
echo "============================================================"
curl -s -X GET "$API/api/findings?run_id=$RUN_ID" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool 2>/dev/null | head -50
echo ""

echo "ðŸ”— Step 8: View Evidence Chain"
echo "============================================================"
curl -s -X GET "$API/api/evidence?run_id=$RUN_ID" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool 2>/dev/null | head -50
echo ""

echo "============================================================"
echo "âœ… DEMO COMPLETE!"
echo "============================================================"
echo ""
echo "ðŸŽ¯ What we demonstrated:"
echo "  âœ“ Authentication & RBAC"
echo "  âœ“ Project & Scope Management"
echo "  âœ“ AI-Powered Test Plan Generation"
echo "  âœ“ Autonomous Pentest Execution"
echo "  âœ“ Real-time Finding Discovery"
echo "  âœ“ Cryptographic Evidence Chain"
echo ""
echo "ðŸ”¥ The AI agents are running in the background!"
echo "   View full API at: http://localhost:8000/docs"
