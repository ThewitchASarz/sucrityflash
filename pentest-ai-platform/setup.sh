#!/bin/bash

# Pentest AI Platform - Setup Script
# This script sets up the development environment

set -e

echo "=================================="
echo "Pentest AI Platform - Setup"
echo "=================================="
echo ""

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "❌ Docker is not installed"
    echo "Please install Docker Desktop from: https://www.docker.com/products/docker-desktop"
    exit 1
fi

echo "✓ Docker found"

# Check if Python 3.11+ is installed
if ! command -v python3 &> /dev/null; then
    echo "❌ Python 3 is not installed"
    echo "Please install Python 3.11+ from: https://www.python.org/downloads/"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
echo "✓ Python $PYTHON_VERSION found"

# Create .env if it doesn't exist
if [ ! -f backend/.env ]; then
    echo "Creating backend/.env from .env.example..."
    cp .env.example backend/.env
    echo "✓ backend/.env created"
else
    echo "✓ backend/.env already exists"
fi

# Start Docker infrastructure
echo ""
echo "Starting Docker services (PostgreSQL, Redis, MinIO)..."
docker compose up -d

echo ""
echo "Waiting for services to be healthy..."
sleep 10

# Check service health
echo "Checking PostgreSQL..."
docker compose exec -T postgres pg_isready -U pentest || echo "⚠️  PostgreSQL not ready yet"

echo "Checking Redis..."
docker compose exec -T redis redis-cli ping || echo "⚠️  Redis not ready yet"

echo ""
echo "=================================="
echo "Setup Complete!"
echo "=================================="
echo ""
echo "Next steps:"
echo "1. cd backend"
echo "2. python3 -m venv venv"
echo "3. source venv/bin/activate  # On Windows: venv\\Scripts\\activate"
echo "4. pip install -r requirements.txt"
echo "5. python main.py"
echo ""
echo "Services:"
echo "- API: http://localhost:8000"
echo "- API Docs: http://localhost:8000/docs"
echo "- MinIO Console: http://localhost:9001 (admin: minioadmin / minioadmin)"
echo ""
