# V2 MVP Implementation Bootstrap

**Date**: December 26, 2025
**Spec**: SecurityFlash-V2-Plan-CORRECTED.md
**Status**: Implementation Starting

---

## Current Repo Structure (V1)

```
pentest-ai-platform/
├── backend/
│   ├── main.py (Control Plane - FastAPI)
│   ├── models/ (11 V1 models)
│   ├── schemas/ (11 V1 schemas)
│   ├── api/ (10 V1 routers)
│   ├── services/ (9 V1 services)
│   ├── agents/ (4 V1 agents + NEW runner.py)
│   ├── workers/ (NEW runner.py)
│   ├── tools/ (nmap only - V1)
│   ├── tools_experimental/ (burp/sqlmap/metasploit quarantined)
│   └── utils/
├── frontend/ (placeholder)
├── docker-compose.yml
└── Documentation/
```

---

## Target V2 Structure (Per Spec)

```
pentest-ai-platform/ (rename to securityflash)
├── apps/
│   ├── api/ (backend/)
│   │   ├── main.py (Control Plane)
│   │   ├── routers/
│   │   │   ├── auth.py (NEW)
│   │   │   ├── projects.py (enhanced)
│   │   │   ├── scopes.py (enhanced)
│   │   │   ├── runs.py (enhanced - timeline)
│   │   │   ├── action_specs.py (V1 exists)
│   │   │   ├── approvals.py (NEW)
│   │   │   ├── evidence.py (enhanced - DELETE 403)
│   │   │   ├── reports.py (NEW)
│   │   │   ├── audit.py (enhanced - bundle)
│   │   │   └── integrations.py (NEW)
│   │   ├── models/
│   │   │   ├── finding.py (NEW)
│   │   │   ├── report_job.py (NEW)
│   │   │   ├── audit_bundle_job.py (NEW)
│   │   │   └── integration_config.py (NEW)
│   │   └── services/
│   │       ├── policy_engine.py (enhanced)
│   │       ├── finding_service.py (NEW)
│   │       ├── report_service.py (NEW)
│   │       └── integration_service.py (NEW)
│   │
│   ├── agents/
│   │   ├── runner.py (V1 exists, enhance)
│   │   ├── orchestrator.py (V1 enhance)
│   │   ├── objective.py (NEW)
│   │   ├── validator.py (NEW)
│   │   └── contracts.py (NEW)
│   │
│   ├── workers/
│   │   ├── runner.py (V1 exists, enhance)
│   │   ├── tools/
│   │   │   ├── tool_validators.py (NEW - structured)
│   │   │   ├── tool_allowlist.py (NEW - enum)
│   │   │   ├── httpx_runner.py (V1)
│   │   │   ├── nmap_runner.py (V1)
│   │   │   ├── dnsx_runner.py (NEW)
│   │   │   ├── subfinder_runner.py (NEW)
│   │   │   ├── katana_runner.py (NEW)
│   │   │   └── ffuf_runner.py (NEW)
│   │   ├── report_generator.py (NEW)
│   │   └── audit_bundle_generator.py (NEW)
│   │
│   └── web/ (NEW - Next.js)
│       ├── src/
│       │   ├── app/ (App Router)
│       │   ├── components/
│       │   ├── hooks/
│       │   └── lib/
│       ├── package.json
│       └── next.config.js
│
├── docs/
│   ├── V2_IMPLEMENTATION_TASKS.md (NEW)
│   ├── V2_GAP_ANALYSIS.md (NEW)
│   ├── V2_API_CONTRACTS.md (NEW)
│   ├── V2_REDIS_STREAMS.md (NEW)
│   ├── V2_RBAC_MATRIX.md (NEW)
│   └── V2_TEST_PLAN.md (NEW)
│
└── infra/
    └── docker-compose.v2.yml (NEW)
```

---

## Highest Risk Items

### 1. Redis Streams Implementation (HIGH RISK)
- **Spec Requirement**: PRIMARY event bus for agent/worker coordination
- **Risk**: Complex Consumer Groups, XREADGROUP, XCLAIM recovery
- **Mitigation**: Implement phase-by-phase, test recovery thoroughly

### 2. Structured Tool Validation (HIGH RISK)
- **Spec Requirement**: FlagSchema per tool, 3-layer enforcement
- **Risk**: Complex validation logic, must reject Stage 2 tools in MVP
- **Mitigation**: Start with simple validators, expand gradually

### 3. Worker Runtime as Continuous Service (MEDIUM RISK)
- **Spec Requirement**: NOT spawned by agents, runs continuously
- **Current V1**: Worker runner exists but needs enhancement
- **Mitigation**: Build on V1 foundation, add Redis Streams consumption

### 4. Multi-Agent Coordination (MEDIUM RISK)
- **Spec Requirement**: OrchestratorAgent, ObjectiveAgent, ValidatorAgent
- **Risk**: Complex spawning, checkpointing, iteration budget
- **Mitigation**: Implement OrchestratorAgent first, add others incrementally

### 5. Finding Validation Framework (MEDIUM RISK)
- **Spec Requirement**: ValidatorAgent confirms findings before report
- **Risk**: Validation logic, timeout handling, state management
- **Mitigation**: Simple replay-and-compare first, enhance later

### 6. Next.js UI (MEDIUM RISK)
- **Spec Requirement**: Full UI with NextAuth.js + TanStack Query
- **Risk**: Large scope, auth integration complexity
- **Mitigation**: Build auth first, then pages incrementally

---

## Implementation Order (Phases)

### Phase 1: Database & Migrations (1-2 days)
- Add findings, report_jobs, audit_bundle_jobs, integration_configs tables
- Create Alembic migration
- Test up/down

### Phase 2: Auth + RBAC (2-3 days)
- Implement POST /api/v1/auth/token
- Add JWT middleware
- Test role enforcement

### Phase 3: Approvals & ActionSpec Lifecycle (3-4 days)
- Implement approvals queue endpoints
- Implement approve/reject with token issuance
- Test state machine

### Phase 4: Tool Expansion (4-5 days)
- Implement structured validators (FlagSchema)
- Add dnsx, subfinder, katana, ffuf runners
- Test Stage 2 rejection at all layers

### Phase 5: Worker Runtime (3-4 days)
- Enhance worker runner with Redis Streams
- Implement XREADGROUP, XCLAIM recovery
- Test approval token verification

### Phase 6: Multi-Agent Runtime (5-6 days)
- Implement ObjectiveAgent, ValidatorAgent
- Add Redis Streams publishing/consumption
- Test agent coordination

### Phase 7: Reporting (2-3 days)
- Implement report generator
- Add HTML/PDF export
- Test validated findings only

### Phase 8: Audit Bundles (1-2 days)
- Implement bundle generator
- Test zip creation

### Phase 9: Integrations (1-2 days)
- Add Slack, Jira, webhook support
- Wire into Control Plane events

### Phase 10: Next.js UI (6-8 days)
- Build auth flow
- Build core pages
- Test RBAC, polling

### Phase 11: Acceptance Testing (2-3 days)
- Full end-to-end tests
- Manual verification

**Total Estimated: 30-40 days**

---

## Order of PRs (if using PRs)

1. **DB Schema & Migrations** (Phase 1)
2. **Auth & JWT** (Phase 2)
3. **Approvals API** (Phase 3)
4. **Tool Validators & Runners** (Phase 4)
5. **Worker Runtime Enhancement** (Phase 5)
6. **Multi-Agent Implementation** (Phase 6)
7. **Reporting System** (Phase 7)
8. **Audit Bundle Export** (Phase 8)
9. **Integrations** (Phase 9)
10. **Next.js UI** (Phase 10)
11. **Acceptance Tests** (Phase 11)

---

## Key Constraints (NON-NEGOTIABLE)

1. ✅ **Control Plane NEVER executes tools**
2. ✅ **Agents NEVER spawn OS processes**
3. ✅ **Workers run continuously, consume from Redis Streams**
4. ✅ **Stage 1 tools ONLY in V2 MVP** (no nuclei/sqlmap/nikto)
5. ✅ **Redis Streams PRIMARY** (DB polling is V2+ fallback)
6. ✅ **FastAPI is identity authority** (NextAuth.js is client layer)
7. ✅ **Evidence DELETE always 403**
8. ✅ **Findings must be validated to appear in report**
9. ✅ **subprocess always uses shell=False**
10. ✅ **n8n is notifications only** (never orchestration/tools/policy)

---

## Next Action

Starting Phase 1: Database Migrations

Creating:
1. `docs/V2_IMPLEMENTATION_TASKS.md` - Task checklist
2. `docs/V2_GAP_ANALYSIS.md` - V1 vs V2 gap analysis
3. New database models
4. Alembic migration

---

**Bootstrap Complete. Beginning Implementation.**
