# V2 MVP Implementation Tasks

**Status**: In Progress
**Updated**: December 26, 2025

---

## Phase 1: Database & Migrations ⏳

- [ ] Create `findings` table with all required columns
  - **Done when**: Table has id, run_id, title, description, severity, evidence_ids, validated, validator_id, validated_at, owasp_mapping, cwe_mapping, timestamps
  - **Done when**: Indexes on run_id and validated exist
- [ ] Create `report_jobs` table
  - **Done when**: Table has id, run_id, format, status, artifact_uri, artifact_hash, progress_percent, error_message, timestamps
  - **Done when**: Indexes on run_id and status exist
- [ ] Create `audit_bundle_jobs` table
  - **Done when**: Table has id, run_id, status, artifact_uri, artifact_hash, timestamps
  - **Done when**: Index on run_id exists
- [ ] Create `integration_configs` table
  - **Done when**: Table has id, type, config (JSONB), enabled, created_at
- [ ] Create SQLAlchemy models for new tables
  - **Done when**: Models in `backend/models/finding.py`, `report_job.py`, `audit_bundle_job.py`, `integration_config.py`
- [ ] Create Alembic migration
  - **Done when**: Migration file `0002_v2_schema.py` creates all tables
  - **Done when**: `alembic upgrade head` succeeds
  - **Done when**: `alembic downgrade -1` succeeds

---

## Phase 2: Auth + RBAC ⏸️

- [ ] Implement `POST /api/v1/auth/token` endpoint
  - **Done when**: Accepts {username, password}, returns JWT with user_id, role, project_ids, expires_at
  - **Done when**: JWT signed with CONTROL_PLANE_SECRET
  - **Done when**: 401 on invalid credentials
- [ ] Add JWT middleware to FastAPI
  - **Done when**: All protected routes require valid JWT
  - **Done when**: JWT payload extracted and available in request context
- [ ] Implement RBAC enforcement
  - **Done when**: Decorator `@require_role("Reviewer")` works
  - **Done when**: Returns 403 if role doesn't match
- [ ] Add audit logging for UI events
  - **Done when**: UI_LOGIN, UI_SCOPE_LOCKED, UI_APPROVAL_SUBMITTED logged
- [ ] Test RBAC matrix
  - **Done when**: Auditor cannot approve, Operator cannot delete evidence, Reviewer can approve

---

## Phase 3: Approvals & ActionSpec Lifecycle ⏸️

- [ ] Implement `GET /api/v1/runs/{run_id}/approvals/pending`
  - **Done when**: Returns pending actions for run
  - **Done when**: Requires Reviewer role
- [ ] Implement `GET /api/v1/approvals` (global)
  - **Done when**: Returns all pending approvals across runs
  - **Done when**: Filtered by role
- [ ] Implement `POST /api/v1/runs/{run_id}/approvals/{action_id}/approve`
  - **Done when**: Issues JWT approval token with run_id, action_id, action_hash, risk_score, tier, expires_at
  - **Done when**: Updates action status to APPROVED
  - **Done when**: Publishes to Redis Stream `securityflash:runs:{run_id}:action-specs`
  - **Done when**: Audit log ACTION_APPROVED with reason
  - **Done when**: Returns 400 if not PENDING_APPROVAL
  - **Done when**: Returns 403 if not Reviewer
- [ ] Implement `POST /api/v1/runs/{run_id}/approvals/{action_id}/reject`
  - **Done when**: Updates action status to REJECTED
  - **Done when**: Audit log ACTION_REJECTED with reason
  - **Done when**: Returns 400 if already rejected
- [ ] Test approval state machine
  - **Done when**: Cannot approve rejected action
  - **Done when**: Cannot reject approved action
  - **Done when**: Approval requires reason

---

## Phase 4: Tool Expansion (Stage 1 Only) ⏸️

- [ ] Create `backend/tools/tool_validators.py`
  - **Done when**: `FlagSchema` dataclass implemented
  - **Done when**: `ToolValidator` base class with `validate_arguments()` method
  - **Done when**: Validators for httpx, nmap, dnsx, subfinder, katana, ffuf
  - **Done when**: Structured validation (domain, CIDR, port_list, url regexes)
- [ ] Create `backend/tools/tool_allowlist.py`
  - **Done when**: `AllowedToolV2MVP` enum with only Stage 1 tools
  - **Done when**: `get_tool_runner()` factory function
- [ ] Implement tool runners
  - **Done when**: `dnsx_runner.py` with safe execution
  - **Done when**: `subfinder_runner.py` with safe execution
  - **Done when**: `katana_runner.py` with safe execution
  - **Done when**: `ffuf_runner.py` with safe execution
  - **Done when**: All use `subprocess(shell=False)`, timeout, output caps
- [ ] Update Policy Engine
  - **Done when**: Checks tool against `TOOL_ALLOWLIST_V2_STAGE1`
  - **Done when**: Rejects nuclei, sqlmap, nikto
- [ ] Test 3-layer enforcement
  - **Done when**: Policy Engine rejects Stage 2 tools
  - **Done when**: Worker enum rejects Stage 2 tools
  - **Done when**: Validator rejects invalid flags
  - **Done when**: subprocess uses shell=False

---

## Phase 5: Worker Runtime (Continuous Service) ⏸️

- [ ] Enhance `backend/workers/runner.py`
  - **Done when**: Runs as continuous service (not spawned)
  - **Done when**: Consumes from Redis Stream `securityflash:runs:{run_id}:action-specs`
  - **Done when**: Uses XREADGROUP with consumer group "workers"
  - **Done when**: Implements recovery (XPENDING + XCLAIM on startup)
  - **Done when**: Verifies approval JWT before execution
  - **Done when**: Posts evidence to `POST /api/v1/runs/{run_id}/evidence`
  - **Done when**: Publishes to Redis Stream `securityflash:runs:{run_id}:evidence`
  - **Done when**: XACK after successful processing
- [ ] Test approval token verification
  - **Done when**: Worker rejects execution without valid token
  - **Done when**: Worker rejects expired token
- [ ] Test Redis Streams recovery
  - **Done when**: Pending messages reclaimed on restart
  - **Done when**: No duplicate execution

---

## Phase 6: Multi-Agent Runtime ⏸️

- [ ] Enhance `backend/agents/orchestrator.py`
  - **Done when**: Spawns ObjectiveAgents via API
  - **Done when**: Tracks spawn limit (max_agents)
  - **Done when**: Consumes Evidence via Redis Stream XREADGROUP (group "agents")
  - **Done when**: Publishes ActionSpecs via API
  - **Done when**: Checkpoints every 5 iterations
- [ ] Implement `backend/agents/objective.py`
  - **Done when**: Accepts objective from Orchestrator
  - **Done when**: Proposes ActionSpecs for objective
  - **Done when**: Consumes Evidence via Redis Stream
  - **Done when**: Emits ValidationProposal
  - **Done when**: Checkpoints every 3 iterations
- [ ] Implement `backend/agents/validator.py`
  - **Done when**: Accepts ValidationProposal
  - **Done when**: Proposes confirmatory ActionSpecs
  - **Done when**: Compares replay evidence with original
  - **Done when**: Emits ValidationResult (APPROVED/REJECTED)
  - **Done when**: Updates findings.validated = true/false
  - **Done when**: Publishes to Redis Stream `securityflash:runs:{run_id}:validation`
- [ ] Implement `backend/agents/contracts.py`
  - **Done when**: Schemas for ObjectiveSpec, ValidationProposal, ValidationResult
- [ ] Test agent coordination
  - **Done when**: Orchestrator spawns ObjectiveAgent
  - **Done when**: ObjectiveAgent proposes actions
  - **Done when**: ValidatorAgent confirms findings
  - **Done when**: Only validated findings in report

---

## Phase 7: Reporting ⏸️

- [ ] Implement `backend/workers/report_generator.py`
  - **Done when**: Generates HTML report from validated findings only
  - **Done when**: Includes executive summary, technical appendix
  - **Done when**: Maps to OWASP Top 10
  - **Done when**: Uploads to MinIO, returns presigned URL
- [ ] Implement `POST /api/v1/runs/{run_id}/report/generate`
  - **Done when**: Enqueues report job
  - **Done when**: Returns 202 Accepted with job_id
- [ ] Implement `GET /api/v1/report-jobs/{job_id}`
  - **Done when**: Returns job status (QUEUED/RUNNING/READY/FAILED)
- [ ] Implement `GET /api/v1/report-jobs/{job_id}/download`
  - **Done when**: Returns presigned URL or raw HTML/PDF
- [ ] Test report generation
  - **Done when**: Only validated findings included
  - **Done when**: Unvalidated findings excluded
  - **Done when**: HTML/PDF downloadable

---

## Phase 8: Audit Bundle Export ⏸️

- [ ] Implement `backend/workers/audit_bundle_generator.py`
  - **Done when**: Creates zip with logs.json, evidence-hashes.csv, report.html, metadata.json
  - **Done when**: Uploads to MinIO
- [ ] Implement `POST /api/v1/audit/bundle/{run_id}/generate`
  - **Done when**: Enqueues bundle job
  - **Done when**: Returns 202 Accepted with job_id
- [ ] Implement `GET /api/v1/audit/bundle-jobs/{job_id}`
  - **Done when**: Returns job status
- [ ] Implement `GET /api/v1/audit/bundle-jobs/{job_id}/download`
  - **Done when**: Returns presigned URL or raw zip
- [ ] Test bundle contents
  - **Done when**: Contains all required files
  - **Done when**: Evidence hashes verifiable

---

## Phase 9: Integrations ⏸️

- [ ] Implement Slack integration
  - **Done when**: Sends notification on approval needed
  - **Done when**: Sends notification on run complete
- [ ] Implement Jira integration
  - **Done when**: Creates ticket for validated finding
- [ ] Implement webhook integration
  - **Done when**: Sends signed webhook on events
- [ ] Add integration_configs CRUD
  - **Done when**: Can create/update/delete integration configs
- [ ] Test notifications
  - **Done when**: Slack message sent
  - **Done when**: Jira ticket created
  - **Done when**: Webhook called

---

## Phase 10: Next.js UI ⏸️

- [ ] Setup Next.js project
  - **Done when**: App Router, TypeScript, Tailwind, shadcn/ui configured
  - **Done when**: TanStack Query configured
- [ ] Implement auth flow
  - **Done when**: NextAuth.js Credentials Provider calls FastAPI /api/v1/auth/token
  - **Done when**: JWT stored in session
  - **Done when**: Auth middleware protects routes
- [ ] Build /login page
  - **Done when**: Username/password form
  - **Done when**: Redirects to /projects on success
- [ ] Build /projects page
  - **Done when**: Lists user's projects
  - **Done when**: Pagination works
  - **Done when**: Create project button
- [ ] Build /projects/[id] page
  - **Done when**: Shows project details, scopes, runs
  - **Done when**: Create scope button
- [ ] Build /scopes/[id] page
  - **Done when**: Shows scope JSON
  - **Done when**: Lock scope button with confirmation
  - **Done when**: Locked indicator visible
- [ ] Build /runs/[runId] page
  - **Done when**: Timeline with polling (5s interval)
  - **Done when**: Action count, evidence count, status
  - **Done when**: Refresh works
- [ ] Build /approvals page
  - **Done when**: Lists pending approvals
  - **Done when**: Approve/reject buttons (Reviewer only)
  - **Done when**: Reason field mandatory
- [ ] Build /evidence/[id] page
  - **Done when**: Shows evidence metadata
  - **Done when**: Download button
  - **Done when**: Hash verification link
  - **Done when**: No delete button
- [ ] Build /reports/[runId] page
  - **Done when**: Preview HTML report
  - **Done when**: Download PDF/HTML
- [ ] Build /audit page
  - **Done when**: Search audit log
  - **Done when**: Filter by event type, actor, date
  - **Done when**: Generate bundle button
- [ ] Test RBAC in UI
  - **Done when**: Operator sees project pages
  - **Done when**: Reviewer sees approval pages
  - **Done when**: Auditor sees audit pages only
  - **Done when**: Role gates work

---

## Phase 11: Acceptance Testing ⏸️

- [ ] Write acceptance test script
  - **Done when**: Tests all must-pass criteria
- [ ] Test UI flows
  - **Done when**: Operator creates project, locks scope, starts run
- [ ] Test tool governance
  - **Done when**: Valid args execute, malicious args rejected
- [ ] Test Stage 1 tools only
  - **Done when**: nuclei/sqlmap/nikto rejected
- [ ] Test worker model
  - **Done when**: Worker runs continuously, consumes from Redis Streams
- [ ] Test evidence immutability
  - **Done when**: DELETE always returns 403
- [ ] Test scope locking
  - **Done when**: Cannot edit locked scope (403)
- [ ] Test finding validation
  - **Done when**: Unvalidated findings excluded from report
- [ ] Test report generation
  - **Done when**: HTML/PDF with validated findings, OWASP mapping
- [ ] Test audit bundle
  - **Done when**: Contains logs, hashes, report, metadata
- [ ] Test RBAC enforcement
  - **Done when**: Auditor cannot approve, Operator cannot delete, Reviewer can approve
- [ ] Test Redis Streams coordination
  - **Done when**: Agents/workers communicate via Consumer Groups
  - **Done when**: XCLAIM recovery works

---

## Progress Summary

- **Phase 1**: 0% (Not Started)
- **Phase 2**: 0% (Not Started)
- **Phase 3**: 0% (Not Started)
- **Phase 4**: 0% (Not Started)
- **Phase 5**: 0% (Not Started)
- **Phase 6**: 0% (Not Started)
- **Phase 7**: 0% (Not Started)
- **Phase 8**: 0% (Not Started)
- **Phase 9**: 0% (Not Started)
- **Phase 10**: 0% (Not Started)
- **Phase 11**: 0% (Not Started)

**Overall**: 0/11 Phases Complete

---

**Next**: Begin Phase 1 - Database Migrations
