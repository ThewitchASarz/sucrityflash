# Pentest AI Platform - V1 MVP

**Status**: V1 Architecture Remediated ‚úÖ
**Version**: 0.1.0
**Architecture**: 3-Runtime Separation of Duties

---

## V1 Architecture

Three separate processes enforce separation of duties:

### 1. Control Plane (FastAPI)
**Role**: Governance only
**Responsibilities**:
- Authentication & RBAC
- Project/Scope/Run management
- ActionSpec approval issuance
- Policy engine
- Audit log persistence
- Evidence metadata storage

**NEVER**:
- Runs tools
- Runs agents
- Runs orchestration loops

### 2. Agent Runtime
**Role**: Proposes ActionSpecs only
**Responsibilities**:
- Reads run state + scope
- Proposes next ActionSpec based on prerequisites
- Marks L0/L1 as `ready_for_execution`
- Marks L2/L3 as `awaiting_approval`
- Waits for approval events

**NEVER**:
- Executes tools
- Spawns OS processes

### 3. Worker Runtime
**Role**: Deterministic execution only
**Responsibilities**:
- Consumes `ready_for_execution` actions
- Validates tool + flags against strict allowlist
- Executes subprocess with `shell=False`, timeout, output caps
- Uploads artifacts to MinIO
- Posts evidence metadata to Control Plane

**NEVER**:
- Reasons or plans

---

## Quick Start (3 Terminals)

### Prerequisites
- Docker Desktop (PostgreSQL, Redis, MinIO)
- Python 3.11+
- nmap installed (`brew install nmap` on macOS)

### Setup

```bash
# 1. Start infrastructure
docker compose up -d

# 2. Setup Python environment
cd backend
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 3. Copy environment template
cp .env.example .env

# 4. Run database migrations
alembic upgrade head
```

### Terminal 1: Control Plane (API)

```bash
cd backend
source venv/bin/activate
python main.py
```

**Verify**: http://localhost:8000/health should return `{"status": "healthy"}`

### Terminal 2: Agent Runtime

```bash
cd backend
source venv/bin/activate
python -m agents.runner
```

**Expected output**:
```
ü§ñ AGENT RUNTIME STARTED
   Role: Propose ActionSpecs only
   Never executes tools or spawns processes
```

### Terminal 3: Worker Runtime

```bash
cd backend
source venv/bin/activate
python -m workers.runner
```

**Expected output**:
```
‚öôÔ∏è  WORKER RUNTIME STARTED
   Role: Execute approved ActionSpecs only
   Allowlisted tools: nmap
   shell=False, timeout enforced, output capped
```

---

## V1 Safety Guarantees

### 1. Tool Allowlist
**Location**: `backend/workers/runner.py`

```python
ALLOWLISTED_TOOLS = {
    "nmap": {
        "command": "nmap",
        "allowed_flags": ["-sV", "-sC", "-p", "-Pn", "-T4"],
        "max_timeout": 300,  # 5 minutes
        "max_output_bytes": 10MB
    }
}
```

**Experimental tools** (sqlmap, metasploit, burpsuite) moved to `backend/tools_experimental/` and NOT loaded.

### 2. Subprocess Safety
All tool execution in Worker Runtime uses:
- `shell=False` (CRITICAL - prevents shell injection)
- Strict timeout enforcement
- Output size caps
- No shell metacharacters in targets

### 3. Scope Validation
Every action validated against:
- Target allowlist (IP/CIDR/domain)
- Excluded systems
- Forbidden methods
- Rules of engagement

**Violation = immediate run halt + audit log**

### 4. Evidence Immutability
- SHA-256 hash chain
- Append-only (DELETE returns 403)
- S3 storage with immutable bucket policy
- Audit log for all access

### 5. Audit Trail
All actions logged to append-only `audit_log` table:
- Actor (USER/AGENT/SYSTEM)
- Action performed
- Resource affected
- Timestamp (immutable)
- IP address (for user actions)

---

## Acceptance Test

Run the automated acceptance test:

```bash
# Start Control Plane in Terminal 1 first
cd backend && python main.py

# Then in another terminal:
./scripts/acceptance_v1.sh
```

**Tests**:
1. ‚úÖ Control Plane has no orchestrator
2. ‚úÖ API creates Project + Scope
3. ‚úÖ Worker allowlist contains only nmap
4. ‚úÖ Worker uses `shell=False`
5. ‚úÖ Evidence API immutable
6. ‚úÖ Secrets properly gitignored
7. ‚úÖ Alembic migrations configured

---

## API Usage

### 1. Register & Login

```bash
# Register coordinator
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "coord@test.com",
    "password": "Pass1234",
    "full_name": "Coordinator",
    "role": "COORDINATOR"
  }'

# Login (get JWT token)
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "coord@test.com",
    "password": "Pass1234"
  }'

# Save the access_token
```

### 2. Create Project + Scope

```bash
# Create project
curl -X POST http://localhost:8000/api/projects \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Project",
    "customer_name": "Acme Corp",
    "description": "Security assessment"
  }'

# Save project_id

# Create scope
curl -X POST http://localhost:8000/api/scopes \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "PROJECT_ID",
    "target_systems": ["192.168.1.0/24", "example.com"],
    "excluded_systems": ["192.168.1.1"],
    "forbidden_methods": ["dos", "social_engineering"],
    "roe": {"max_concurrent_scans": 3}
  }'
```

### 3. Lock Scope (Dual Signature)

Requires RSA signing keys (see `/api/auth/signing-key` endpoint).

### 4. Generate Test Plan

Requires LLM configuration (see `.env.example`).

### 5. Monitor Runs

```bash
# List runs
curl http://localhost:8000/api/runs \
  -H "Authorization: Bearer YOUR_TOKEN"

# Get run details
curl http://localhost:8000/api/runs/RUN_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## Database Migrations

### Create Migration

```bash
cd backend
alembic revision --autogenerate -m "Description"
```

### Apply Migrations

```bash
alembic upgrade head
```

### Rollback

```bash
alembic downgrade -1
```

---

## Configuration

See `backend/.env.example` for all configuration options.

**Critical settings**:

```bash
# Database
DATABASE_URL=postgresql+asyncpg://pentest:pentest@localhost:5432/pentest_db

# JWT (CHANGE IN PRODUCTION)
JWT_SECRET=CHANGE_ME_TO_RANDOM_SECRET_KEY

# LLM (optional for V1 basic testing)
LLM_PROVIDER=local  # or "claude"
LLM_TEMPERATURE=0  # MUST be 0
```

---

## Security Checklist

Before production:

- [ ] Change `JWT_SECRET` to strong random value
- [ ] Enable TLS/HTTPS
- [ ] Configure firewall (only allow API on 8000)
- [ ] Set up MinIO bucket immutability policy
- [ ] Configure PostgreSQL audit logging
- [ ] Set up monitoring/alerting
- [ ] Review and update tool allowlist
- [ ] Implement rate limiting
- [ ] Enable 2FA for APPROVER/CISO roles
- [ ] Set up backup strategy
- [ ] Review audit logs regularly

---

## Troubleshooting

### Control Plane won't start

```bash
# Check Docker services
docker compose ps

# Check database connection
docker compose logs postgres

# Check .env file exists
ls -la backend/.env
```

### Agent Runtime not proposing actions

```bash
# Check run status in database
docker compose exec postgres psql -U pentest -d pentest_db -c "SELECT id, status FROM runs;"

# Check for errors in agent output
```

### Worker Runtime not executing

```bash
# Check action status
docker compose exec postgres psql -U pentest -d pentest_db -c "SELECT id, action_id, status FROM actions WHERE status='ready_for_execution';"

# Verify nmap is installed
which nmap
```

### Tool allowlist violations

Check worker logs for details. Violations are audited to `audit_log` table.

---

## API Documentation

Interactive docs: http://localhost:8000/docs

**Available endpoints** (50+):
- `/api/auth/*` - Authentication (6)
- `/api/projects/*` - Projects (4)
- `/api/scopes/*` - Scopes (3)
- `/api/test-plans/*` - Test Plans (4)
- `/api/runs/*` - Runs (4)
- `/api/approvals/*` - Approvals (5)
- `/api/evidence/*` - Evidence (3)
- `/api/findings/*` - Findings (4)
- `/api/audit/*` - Audit Logs (1)
- `/api/reports/*` - Reports (1)

---

## V1 ‚Üí V2 Migration Path

V1 provides the foundation. V2 will add:
- Enhanced tool safety (gradual relaxation with more controls)
- Agent reasoning traces (explainability)
- Multi-agent coordination
- Advanced policy engine
- Real-time monitoring UI
- Integration with SIEM/SOAR

**V1 is production-ready for basic reconnaissance with nmap only.**

---

## Support

- Documentation: `Documentation/` directory
- Issues: Create GitHub issue
- Architecture: See `ARCHITECTURE.md`

---

**Built with**: FastAPI, PostgreSQL, Redis, MinIO
**LLM**: Claude 3.5 Sonnet or Llama 3.1 70B
**License**: TBD
