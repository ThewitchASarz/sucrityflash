#!/bin/bash
# Startup script for AI Pentest Platform

echo "============================================================"
echo "ğŸš€ Starting AI Pentest Platform"
echo "============================================================"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âš ï¸  Docker is not running. Starting Docker..."
    open -a Docker
    echo "   Waiting for Docker to start..."
    sleep 15
fi

# Start infrastructure services
echo "ğŸ“¦ Starting infrastructure (PostgreSQL, Redis, MinIO)..."
docker compose up -d

echo "   Waiting for services to be healthy..."
sleep 5

# Check if backend dependencies are installed
if ! python3 -c "import fastapi" 2>/dev/null; then
    echo "ğŸ“¦ Installing backend dependencies..."
    cd backend
    pip3 install -q -r requirements.txt --user
    cd ..
fi

# Start backend
echo "ğŸ”§ Starting backend API..."
cd backend
pkill -9 -f "uvicorn main:app" 2>/dev/null
/Users/annalealayton/Library/Python/3.9/bin/uvicorn main:app --host 0.0.0.0 --port 8000 > /tmp/pentest-backend.log 2>&1 &
BACKEND_PID=$!
cd ..

echo "   Waiting for backend to start..."
sleep 5

# Start frontend
echo "ğŸ¨ Starting frontend UI..."
cd frontend
pkill -9 -f "react-scripts start" 2>/dev/null
npm start > /tmp/pentest-frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..

echo ""
echo "â³ Waiting for services to be ready..."
sleep 10

echo ""
echo "============================================================"
echo "âœ… AI Pentest Platform is RUNNING!"
echo "============================================================"
echo ""
echo "ğŸŒ Access Points:"
echo "   â€¢ Frontend UI:  http://localhost:3000"
echo "   â€¢ Backend API:  http://localhost:8000"
echo "   â€¢ API Docs:     http://localhost:8000/docs"
echo ""
echo "ğŸ” Login Credentials:"
echo "   Email:    admin@test.com"
echo "   Password: password123"
echo ""
echo "ğŸ“Š Service Status:"
docker compose ps 2>/dev/null | grep -E "NAME|postgres|redis|minio"
echo ""
echo "ğŸ“ Logs:"
echo "   Backend:  tail -f /tmp/pentest-backend.log"
echo "   Frontend: tail -f /tmp/pentest-frontend.log"
echo ""
echo "ğŸ›‘ To stop: ./stop.sh"
echo ""
echo "============================================================"

# Open browser
sleep 3
echo "ğŸŒ Opening browser..."
open http://localhost:3000

echo ""
echo "âœ¨ Ready to test! The AI agents are running in the background."
