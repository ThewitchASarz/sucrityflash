#!/bin/bash
# SecurityFlash - Complete Pentest Workflow
# Demonstrates full end-to-end pentest via V2 BFF

set -e

BFF_URL="http://localhost:3001/api/v1"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ›¡ï¸  SecurityFlash - Pentest Workflow Demo"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Target: example.com (safe test domain)"
echo "API: $BFF_URL (V2 BFF -> V1 Proxy)"
echo ""

# Step 1: Create Project
echo "[1/3] ğŸ“ Creating pentest project..."
PROJECT=$(curl -s -X POST "$BFF_URL/projects" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Example.com Security Assessment",
    "customer_id": "customer-123",
    "created_by": "security-team",
    "rules_of_engagement": "Non-intrusive reconnaissance only. Target: example.com domain."
  }')

PROJECT_ID=$(echo "$PROJECT" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null)

if [ -z "$PROJECT_ID" ]; then
  echo "âŒ Failed to create project"
  echo "$PROJECT"
  exit 1
fi

echo "   âœ… Project Created: $PROJECT_ID"
echo ""

# Step 2: Create Scope
echo "[2/3] ğŸ¯ Defining pentest scope..."
SCOPE=$(curl -s -X POST "$BFF_URL/projects/$PROJECT_ID/scopes" \
  -H "Content-Type: application/json" \
  -d '{
    "scope_type": "web_app",
    "targets": [
      {
        "type": "domain",
        "value": "example.com",
        "description": "Primary target domain"
      },
      {
        "type": "ip",
        "value": "93.184.216.34",
        "description": "Example.com IP address"
      }
    ],
    "excluded_targets": [],
    "attack_vectors_allowed": [
      "reconnaissance",
      "information_gathering",
      "port_scanning"
    ],
    "attack_vectors_prohibited": [
      "sql_injection",
      "xss",
      "command_injection",
      "dos"
    ],
    "approved_tools": [
      "nmap",
      "curl",
      "dig",
      "whois",
      "nslookup"
    ]
  }')

SCOPE_ID=$(echo "$SCOPE" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null)

if [ -z "$SCOPE_ID" ]; then
  echo "âŒ Failed to create scope"
  echo "$SCOPE"
  exit 1
fi

echo "   âœ… Scope Defined: $SCOPE_ID"
echo ""

# Step 3: Create Run
echo "[3/3] ğŸš€ Creating pentest run..."
RUN=$(curl -s -X POST "$BFF_URL/projects/$PROJECT_ID/runs" \
  -H "Content-Type: application/json" \
  -d "{
    \"scope_id\": \"$SCOPE_ID\",
    \"policy_version\": \"1.0.0\",
    \"max_iterations\": 50,
    \"created_by\": \"security-team\"
  }")

RUN_ID=$(echo "$RUN" | python3 -c "import sys, json; print(json.load(sys.stdin)['id'])" 2>/dev/null)

if [ -z "$RUN_ID" ]; then
  echo "âŒ Failed to create run"
  echo "$RUN"
  exit 1
fi

echo "   âœ… Run Created: $RUN_ID"
echo ""

# Summary
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Pentest Successfully Created!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Resource IDs:"
echo "   Project: $PROJECT_ID"
echo "   Scope:   $SCOPE_ID"
echo "   Run:     $RUN_ID"
echo ""
echo "ğŸ”— Access Points:"
echo "   V2 BFF:  $BFF_URL/projects/$PROJECT_ID"
echo "   V1 API:  http://localhost:8000/api/v1/projects/$PROJECT_ID"
echo ""
echo "ğŸ“‹ Next Steps:"
echo "   1. Start the run:"
echo "      curl -X POST $BFF_URL/runs/$RUN_ID/start"
echo ""
echo "   2. View project details:"
echo "      curl $BFF_URL/projects/$PROJECT_ID | python3 -m json.tool"
echo ""
echo "   3. List all projects:"
echo "      curl $BFF_URL/projects | python3 -m json.tool"
echo ""
echo "   4. Start the UI:"
echo "      cd pentest-ai-platform/frontend && npm start"
echo "      Open: http://localhost:3000"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
